<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Heatmap</title>
<meta name="description" content="Hover-only ticker heatmap from Active54 — fixed 6 tiles per row; detail card on hover only." />
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.tailwindcss.com"></script>
<style>
  :root{ --brand:#8B0000; --brand-ink:#7a0000; --ink:#111; --muted:#6b7280; --bg:#fff; --card:#fff; }
  html { font-family: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial; }
  body { background: var(--bg); color: var(--ink); }
  .container { max-width: 80rem; margin: 0 auto; padding-left: 1rem; padding-right: 1rem; }

  /* Marquee */
  .ticker-rail { position: relative; overflow: hidden; }
  .ticker { display:flex; width:max-content; white-space:nowrap; gap:2.5rem; }
  .ticker-left  { animation: scroll-left 120s linear infinite; }
  .ticker-right { animation: scroll-right 120s linear infinite; }
  .ticker:hover { animation-play-state: paused; }
  @keyframes scroll-left  { 0% { transform:translateX(0) } 100% { transform: translateX(-50%) } }
  @keyframes scroll-right { 0% { transform:translateX(-50%) } 100% { transform: translateX(0) } }
  @media (prefers-reduced-motion: reduce){ .ticker-left, .ticker-right { animation: none; } }

  /* Grid — fixed 6 tiles per row on desktop */
  .heatmap {
    display:grid;
    grid-template-columns: repeat(2, minmax(0,1fr)); /* phones */
    grid-auto-rows: 120px;
    gap: 1rem;
  }
  @media (min-width: 640px){ .heatmap { grid-template-columns: repeat(3, minmax(0,1fr)); } }
  @media (min-width: 768px){ .heatmap { grid-template-columns: repeat(4, minmax(0,1fr)); } }
  @media (min-width: 1024px){ .heatmap { grid-template-columns: repeat(6, minmax(0,1fr)); } }

  .tile { border-radius: .9rem; position: relative; overflow: hidden; border: 1px solid rgba(0,0,0,.06); }
  .tile .inner { padding: 1rem; height:100%; display:flex; flex-direction:column; justify-content:space-between; }
  .tile .top { display:flex; align-items:flex-start; justify-content:space-between; gap:.75rem; }
  .tile .name { font-size:1rem; font-weight:800; line-height:1.15; letter-spacing:.01em; }
  .tile .pill { font-weight:800; font-size:.75rem; padding:.22rem .5rem; border-radius:.45rem; background: rgba(255,255,255,.2); white-space:nowrap; }
  .tile .meta { display:flex; align-items:center; gap:.5rem; font-size:.82rem; opacity:.95; }

  /* Sparkline */
  .spark { width:100%; height:38px; margin-top:.5rem; }
  .spark path { fill:none; stroke-width:2; vector-effect:non-scaling-stroke; }

  /* HoverCard (hover-only: pointer-events none so it never “pins”) */
  .hovercard {
    position: fixed; z-index: 60;
    max-width: 380px; width: max-content;
    background: #111; color:#fff;
    border-radius: .65rem; border:1px solid rgba(255,255,255,.12);
    box-shadow: 0 20px 40px rgba(0,0,0,.3);
    padding: .8rem .9rem;
    opacity: 0; transform: translateY(4px) scale(.98);
    transition: opacity .12s ease, transform .12s ease;
    pointer-events: none; /* important: no interaction, vanishes off-hover */
  }
  .hovercard[data-show="true"] { opacity:1; transform: translateY(0) scale(1); }
  .hovercard h4 { font-size:.95rem; font-weight:700; margin: 0 0 .2rem 0; line-height:1.25; }
  .hovercard .grid { display:grid; grid-template-columns: auto 1fr; gap:.35rem .8rem; margin-top:.45rem; font-size:.85rem; }
  .hovercard .label { color:#d1d5db; white-space:nowrap; }
  .hovercard .val { color:#fff; word-break: break-word; }

  /* Footer */
  .footer-red { background: var(--brand-ink); color:#fff; }
  .footer-red a { color: rgba(255,255,255,.92); }
  .footer-red a:hover { color:#fff; text-decoration: underline; }
  .footer-red .heading { font-size:.85rem; font-weight:700; letter-spacing:.04em; text-transform:uppercase; color: rgba(255,255,255,.82); }
  .footer-red .muted { color: rgba(255,255,255,.78); }
  .footer-red .divider { border-top:1px solid rgba(255,255,255,.18); }
  .footer-red .chip { font-size:.72rem; border:1px solid rgba(255,255,255,.28); border-radius:999px; padding:.25rem .5rem; color:#fff; background: rgba(255,255,255,.08); }
  .diag { background:#fff7ed; border-bottom:1px solid #fed7aa; color:#9a3412; }
</style>
</head>
<body>
  <!-- Top Ticker -->
  <div class="w-full bg-[var(--brand-ink)] text-white">
    <div class="flex items-center gap-3 py-2 px-4 sm:px-6 lg:px-8">
      <span class="inline-flex items-center gap-2 text-xs font-semibold bg-white/10 px-2.5 py-1 rounded-full">
        <span class="inline-block h-2 w-2 rounded-full bg-emerald-400 animate-pulse"></span> LIVE
      </span>
      <div class="ticker-rail flex-1" aria-label="Top market headlines" aria-live="polite">
        <div id="topTicker" class="ticker ticker-right text-sm font-medium"></div>
      </div>
    </div>
  </div>

  <!-- Header -->
  <header class="sticky top-0 z-40 border-b bg-white/90 backdrop-blur supports-[backdrop-filter]:bg-white/70">
    <div class="container flex items-center justify-between py-3">
      <a href="/" class="flex items-center gap-3">
        <span class="grid place-items-center h-9 w-9 rounded-xl bg-[var(--brand)] text-white font-bold shadow-sm">bS</span>
        <div>
          <div class="text-lg font-bold leading-tight">bataSutra</div>
          <div class="text-xs text-[var(--muted)] -mt-0.5">News, context & tools</div>
        </div>
      </a>
      <div id="countInfo" class="text-xs text-slate-600"></div>
    </div>
  </header>

  <!-- Diagnostics (auto-hides if no issues) -->
  <div id="diag" class="diag hidden">
    <div class="container py-2 text-[12px]" id="diagText"></div>
  </div>

  <!-- Main -->
  <main class="container py-8">
    <section class="pb-4">
      <h1 class="text-2xl sm:text-3xl font-extrabold tracking-tight">Heatmap</h1>
      <p class="text-slate-600 mt-2">Color = % change (1D)</p>
      <div id="lastUpdated" class="text-xs text-slate-500 mt-1"></div>
    </section>

    <!-- Legend -->
    <div class="flex items-center justify-between flex-wrap gap-3">
      <div class="flex items-center gap-3 text-xs text-slate-600">
        <span>-5%</span>
        <div class="legend w-48 sm:w-64 md:w-80" style="height:10px;border-radius:999px;background:linear-gradient(90deg,#dc2626,#f59e0b,#16a34a)"></div>
        <span>+5%</span>
      </div>
      <div id="rangeInfo" class="text-xs text-slate-500"></div>
    </div>

    <!-- Heatmap Grid -->
    <section id="heatmapWrap" class="mt-6">
      <div id="heatmap" class="heatmap">
        <!-- skeleton tiles -->
        <div class="tile" style="background:#f3f4f6"></div>
        <div class="tile" style="background:#f3f4f6"></div>
        <div class="tile" style="background:#f3f4f6"></div>
        <div class="tile" style="background:#f3f4f6"></div>
        <div class="tile" style="background:#f3f4f6"></div>
        <div class="tile" style="background:#f3f4f6"></div>
      </div>
      <p id="emptyState" class="text-center text-slate-500 text-sm mt-8 hidden">No tickers found.</p>
    </section>
  </main>

  <!-- Bottom Ticker -->
  <div class="w-full bg-slate-100 border-y">
    <div class="py-3 px-4 sm:px-6 lg:px-8">
      <div class="ticker-rail" aria-label="Bottom market headlines">
        <div id="bottomTicker" class="ticker ticker-left text-sm font-medium"></div>
      </div>
    </div>
  </div>

  <!-- Footer -->
  <footer class="footer-red text-sm">
    <div class="divider"></div>
    <div class="container py-10">
      <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-6">
        <a href="/" class="flex items-center gap-3">
          <span class="grid place-items-center h-9 w-9 rounded-xl bg-[var(--brand)] text-white font-bold shadow-sm">bS</span>
          <div>
            <div class="text-lg font-bold leading-tight">bataSutra</div>
            <div class="text-xs muted -mt-0.5"></div>
          </div>
        </a>
        <p class="muted max-w-2xl"></p>
      </div>

      <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-6 gap-8 mt-10">
        <div>
          <div class="heading mb-3">Editorial</div>
          <ul class="space-y-2">
            <li><a href="/articles">Latest</a></li>
            <li><a href="/deep-dive">Deep Dives</a></li>
            <li><a href="/weekend-wrap">Weekend Wrap</a></li>
            <li><a href="/explainers">Explainers</a></li>
          </ul>
        </div>
        <div>
          <div class="heading mb-3">Data</div>
          <ul class="space-y-2">
            <li><a href="/#indices">Indices</a></li>
            <li><a href="/heatmap">Sector Heatmap</a></li>
            <li><a href="/#commodities">Commodities</a></li>
          </ul>
        </div>
        <div>
          <div class="heading mb-3">Tools</div>
          <ul class="space-y-2">
            <li><a href="/tools">All Tools</a></li>
            <li><a href="/tools/sip-planner">SIP Goal &amp; Corpus</a></li>
            <li><a href="/tools/cagr">CAGR &amp; Quick IRR</a></li>
          </ul>
        </div>
        <div>
          <div class="heading mb-3">Company</div>
          <ul class="space-y-2">
            <li><a href="/about">About</a></li>
            <li><a href="/advertise">Advertising</a></li>
            <li><a href="/partnerships">Partnerships</a></li>
          </ul>
        </div>
        <div>
          <div class="heading mb-3">Resources</div>
          <ul class="space-y-2">
            <li><a href="/methodology">Methodology</a></li>
            <li><a href="/data-sources">Data Sources</a></li>
            <li><a href="/editorial-policy">Editorial Policy</a></li>
          </ul>
        </div>
        <div>
          <div class="heading mb-3">Legal</div>
          <ul class="space-y-2">
            <li><a href="/privacy">Privacy Policy</a></li>
            <li><a href="/terms">Terms of Service</a></li>
          </ul>
        </div>
      </div>

      <div class="divider mt-10"></div>
      <div class="py-6 flex flex-col md:flex-row items-start md:items-center justify-between gap-4">
        <div class="muted">&copy; <span id="year"></span> bataSutra. All rights reserved.</div>
        <div class="flex items-center gap-4 muted">
          <button type="button" class="chip" onclick="window.scrollTo({top:0,behavior:'smooth'})">Back to top ↑</button>
        </div>
      </div>
    </div>
  </footer>

  <!-- Hover-only card -->
  <div id="hoverCard" class="hovercard" aria-hidden="true">
    <h4 id="hcTitle"></h4>
    <div class="grid">
      <div class="label">Symbol</div><div class="val" id="hcSym"></div>
      <div class="label">% Change</div><div class="val" id="hcPct"></div>
      <div class="label">Last</div><div class="val" id="hcLast"></div>
      <div class="label">Change</div><div class="val" id="hcChg"></div>
      <div class="label">High</div><div class="val" id="hcHigh"></div>
      <div class="label">Low</div><div class="val" id="hcLow"></div>
      <div class="label">Volume</div><div class="val" id="hcVol"></div>
      <div class="label">Mkt Cap</div><div class="val" id="hcMcap"></div>
    </div>
  </div>

<script>
/* ===== PRESET ORDER ===== */
const TICKER_ORDER = [
  'RELIANCE','TCS','HDFCBANK','ICICIBANK','SBIN','INFY','ITC','LT','BHARTIARTL','HINDUNILVR',
  'AXISBANK','KOTAKBANK','BAJFINANCE','BAJAJFINSV','MARUTI','TATAMOTORS','M&M','TITAN','ULTRACEMCO','GRASIM',
  'HCLTECH','WIPRO','LTIM','TECHM','SUNPHARMA','CIPLA','DRREDDY','APOLLOHOSP','HDFCLIFE','SBILIFE',
  'ONGC','COALINDIA','NTPC','POWERGRID','ADANIENT','ADANIPORTS','JSWSTEEL','TATASTEEL','HINDALCO','INDUSINDBK',
  'BANKBARODA','PNB','IDFCFIRSTB','DLF','NESTLEIND','BRITANNIA','DMART','ASIANPAINT','EICHERMOT','HEROMOTOCO',
  'BAJAJ-AUTO','ZOMATO','POLICYBZR','IRCTC'
];

/* ===== SHEETS ===== */
const HEADLINES_SHEET_ID = '1WN8151jGQjqbfO0Aj2tK-79yJ9gCD_z0DLCdxs_higg'; // marquee
const HEATMAP_SHEET_ID   = '1CoU49NHIMLKUsVIFPBG0VpAorburhnTbMi-IG_m_dcA';  // Active54 workbook
const HEATMAP_TAB        = 'Active54';

/* ===== CSV ===== */
const csvUrl = (sheetId, sheet, range) =>
  `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(sheet)}&range=${encodeURIComponent(range)}&t=${Date.now()}`;

function parseCsv(text){
  if ((text||'').trim().startsWith('<')) return { rows: [], isHtml:true };
  const rows=[]; let row=[], cur='', inQuotes=false;
  for(let i=0;i<text.length;i++){
    const ch=text[i];
    if(inQuotes){
      if(ch === '"'){ if(text[i+1] === '"'){ cur+='"'; i++; } else { inQuotes=false; } }
      else cur+=ch;
    } else {
      if(ch === '"') inQuotes=true;
      else if(ch === ','){ row.push(cur); cur=''; }
      else if(ch === '\n'){ row.push(cur); rows.push(row); row=[]; cur=''; }
      else if(ch === '\r'){ } else cur+=ch;
    }
  }
  if(cur.length>0 || row.length>0){ row.push(cur); rows.push(row); }
  return { rows, isHtml:false };
}

async function fetchSheetObjects(sheetId, sheet, range){
  const res = await fetch(csvUrl(sheetId, sheet, range));
  if(!res.ok) throw new Error(`Sheet fetch failed: ${sheetId}/${sheet} (${res.status})`);
  const txt = await res.text();
  const { rows, isHtml } = parseCsv(txt);
  if (isHtml) { const e = new Error('Sheet returned HTML (likely not public/published)'); e.code='HTML'; throw e; }
  if(!rows.length) return [];
  const headers = rows[0].map(h => h.replace(/^\uFEFF/,'').replace(/\u00A0/g,' ').trim());
  return rows.slice(1)
    .filter(r => r.some(x => (x??'').toString().trim()!==''))
    .map(r => Object.fromEntries(headers.map((h,i)=>[h, (r[i]??'').toString().trim()])));
}

/* ===== HELPERS ===== */
const pick = (obj, keys) => { for (const k of keys){ const v=obj[k]; if(v!=null && String(v).trim()!=='') return v; } const want=(keys[0]||'').toLowerCase(); for(const k of Object.keys(obj)){ if(k.toLowerCase().includes(want) && String(obj[k]).trim()!=='') return obj[k]; } return undefined; };

function cleanNumStr(s){
  if (s==null) return '';
  return String(s)
    .replace(/[₹,]/g,'')
    .replace(/\u00A0/g,' ')
    .replace(/[()%]/g,'')
    .replace(/[−–—]/g,'-')
    .trim();
}
function toNum(x){
  const s = cleanNumStr(x);
  if (!s) return NaN;
  const n = Number(s);
  return Number.isFinite(n) ? n : NaN;
}

const clamp = (v, lo, hi) => Math.min(hi, Math.max(lo, v));
const lerp  = (a,b,t) => a + (b-a)*t;

function colorForPct(pct){
  if (!Number.isFinite(pct)) return { bg:'#e5e7eb', fg:'#111' };
  const p = clamp(pct, -5, 5);
  const t = (p + 5) / 10;
  function hex(c){ return c.toString(16).padStart(2,'0'); }
  function mix3(a,b,c,t){ if (t<=0.5){ const tt=t/0.5; return [Math.round(lerp(a[0],b[0],tt)), Math.round(lerp(a[1],b[1],tt)) , Math.round(lerp(a[2],b[2],tt))]; } const tt=(t-0.5)/0.5; return [Math.round(lerp(b[0],c[0],tt)), Math.round(lerp(b[1],c[1],tt)), Math.round(lerp(b[2],c[2],tt))]; }
  const R=[220,38,38], A=[245,158,11], G=[22,163,74];
  const [r,g,b] = mix3(R,A,G,t);
  const lum = (0.2126*r + 0.7152*g + 0.0722*b)/255;
  const fg = lum < 0.55 ? '#fff' : '#111';
  return { bg: `#${hex(r)}${hex(g)}${hex(b)}`, fg };
}

function sparkPath(vals){
  const nums = vals.map(toNum).filter(Number.isFinite);
  if (!nums.length) return '';
  const w=100, h=30, pad=2;
  const min = Math.min(...nums), max = Math.max(...nums), span = (max-min)||1;
  return nums.map((v,i)=>{
    const x=(i/(nums.length-1))*w;
    const y=h-pad-((v-min)/span)*(h-2*pad);
    return (i?'L':'M')+x.toFixed(2)+','+y.toFixed(2);
  }).join(' ');
}

/* Normalize one row (Active54 headers) */
function normRowTicker(r){
  const sym = (pick(r,['Symbol','Ticker','Code']) || '').toUpperCase().trim();
  const name = pick(r,['Name','Company','Label']) || sym || '—';
  const last = toNum(pick(r,['Price','Last','Value','Close']));
  const chg  = toNum(pick(r,['Change','Chg']));
  const chgp = toNum(pick(r,['% Change','%Change','%Chg','ChangePct','Pct']));
  const high = pick(r,['High']) || '';
  const low  = pick(r,['Low']) || '';
  const vol  = pick(r,['Volume']) || '';
  const mcap = pick(r,['Mkt Cap','Market Cap','Mcap']) || '';
  let spark = pick(r,['7D Spark','Spark']);
  if (!spark) {
    const keys = Object.keys(r).filter(k => /^s\d+$/i.test(k));
    if (keys.length) spark = keys.sort((a,b)=>Number(a.slice(1))-Number(b.slice(1))).map(k=>r[k]).join(',');
  }
  const sparkVals = (spark||'').split(',').map(s=>s.trim()).filter(Boolean);
  return { sym, name, last, chg, chgp, high, low, vol, mcap, sparkVals };
}

/* Build map: SYMBOL -> normalized row */
function indexBySymbol(rows){
  const map = new Map();
  rows.forEach(r=>{
    const n = normRowTicker(r);
    if (n.sym) map.set(n.sym, n);
  });
  return map;
}

/* ===== UI bits ===== */
function makeTileHTMLTicker(row, colors, i){
  const pctTxt  = Number.isFinite(row.chgp) ? ((row.chgp>=0?'+':'') + row.chgp.toFixed(2) + '%') : '—';
  const lastTxt = Number.isFinite(row.last) ? row.last.toLocaleString('en-IN',{maximumFractionDigits:2,minimumFractionDigits:2}) : '—';
  const chgTxt  = (row.chg===''||row.chg==null) ? null
                : (Number.isFinite(row.chg) ? ((row.chg>=0?'+':'') + row.chg.toLocaleString('en-IN',{maximumFractionDigits:2,minimumFractionDigits:2})) : String(row.chg));
  const stroke = Number.isFinite(row.chgp)&&row.chgp>=0?'#16a34a':'#dc2626';
  const hasSpark = row.sparkVals && row.sparkVals.length>=2;

  const data = `
    data-sym="${row.sym}"
    data-name="${row.name.replace(/"/g,'&quot;')}"
    data-pct="${pctTxt}"
    data-last="${lastTxt}"
    data-chg="${chgTxt || ''}"
    data-high="${(row.high||'')}"
    data-low="${(row.low||'')}"
    data-vol="${(row.vol||'')}"
    data-mcap="${(row.mcap||'')}"
  `;

  return `
    <div class="tile" style="background:${colors.bg}; color:${colors.fg}" aria-label="${row.sym}: ${pctTxt}" ${data}>
      <div class="inner">
        <div class="top">
          <div class="min-w-0">
            <div class="name truncate" title="${row.name}">${row.sym}</div>
            <div class="meta"><span>${lastTxt}</span></div>
          </div>
          <span class="pill">${pctTxt}</span>
        </div>
        ${hasSpark ? `
          <svg class="spark" viewBox="0 0 100 30" preserveAspectRatio="none" aria-hidden="true">
            <path id="spark-${i}" d="" stroke="${stroke}"></path>
          </svg>` : `<div style="height:38px"></div>`}
      </div>
    </div>`;
}
function paintSpark(row, i){
  const path = sparkPath(row.sparkVals);
  if (!path) return;
  const p = document.getElementById(`spark-${i}`);
  if (p) p.setAttribute('d', path);
}

/* Hover-only card controller */
const hc = {
  el:null, hideTo:null,
  init(){
    this.el = document.getElementById('hoverCard');
  },
  fill(tile){
    document.getElementById('hcTitle').textContent = tile.dataset.name || tile.dataset.sym || '';
    document.getElementById('hcSym').textContent   = tile.dataset.sym || '—';
    document.getElementById('hcPct').textContent   = tile.dataset.pct || '—';
    document.getElementById('hcLast').textContent  = tile.dataset.last || '—';
    document.getElementById('hcChg').textContent   = tile.dataset.chg || '—';
    document.getElementById('hcHigh').textContent  = tile.dataset.high || '—';
    document.getElementById('hcLow').textContent   = tile.dataset.low || '—';
    document.getElementById('hcVol').textContent   = tile.dataset.vol || '—';
    document.getElementById('hcMcap').textContent  = tile.dataset.mcap || '—';
  },
  position(tile){
    const r = tile.getBoundingClientRect();
    const vw = innerWidth, vh = innerHeight;
    const card = this.el;
    const cardW = Math.min(380, vw - 24);
    // Prefer above if tile is lower half
    let x = r.left + Math.min(16, Math.max(8, r.width * 0.1));
    let y = (r.top > vh/2) ? (r.top - 12) : (r.bottom + 12);
    if (x + cardW + 12 > vw) x = vw - cardW - 12;
    if (x < 12) x = 12;

    // measure height invisibly
    card.style.visibility='hidden'; card.style.display='block'; card.style.width=cardW+'px';
    const h = card.offsetHeight || 200;
    card.style.display=''; card.style.visibility='';

    if (r.top > vh/2 && (y - h < 8)) y = r.bottom + 12;
    if (r.top <= vh/2 && (y + h > vh - 8)) y = r.top - 12;
    if (y < 8) y = 8; if (y + h > vh - 8) y = vh - h - 8;

    card.style.left = `${x}px`;
    card.style.top  = `${y}px`;
  },
  show(tile){
    if (this.hideTo){ clearTimeout(this.hideTo); this.hideTo = null; }
    this.fill(tile);
    this.position(tile);
    this.el.setAttribute('data-show','true');
    this.el.setAttribute('aria-hidden','false');
  },
  hide(){
    if (this.hideTo){ clearTimeout(this.hideTo); }
    // small delay prevents flicker when moving between adjacent tiles
    this.hideTo = setTimeout(()=>{
      this.el.removeAttribute('data-show');
      this.el.setAttribute('aria-hidden','true');
    }, 80);
  }
};

/* Marquee + Diagnostics */
function renderMarquee(id, items, dir='right'){
  const el = document.getElementById(id); if (!el) return;
  el.className = `ticker ${dir==='right'?'ticker-right':'ticker-left'} text-sm font-medium`;
  el.innerHTML = '';
  const loop = [...items, ...items];
  loop.forEach(t => { const s=document.createElement('span'); s.textContent=t; el.appendChild(s); });
}
function showDiag(msg){
  const bar = document.getElementById('diag');
  const txt = document.getElementById('diagText');
  txt.textContent = msg; bar.classList.remove('hidden');
}

/* ===== DATA LOADING ===== */
async function loadActive54(){
  try {
    const rows = await fetchSheetObjects(HEATMAP_SHEET_ID, HEATMAP_TAB, 'A:Z');
    return rows;
  } catch (e){
    console.warn('Active54 load failed:', e);
    showDiag('Live sheet not accessible — using built-in fallback. Tip: Share the tab publicly and “Publish to the web”.');
    return [];
  }
}
function fallbackRows(){
  return TICKER_ORDER.map(sym => ({
    Name: sym, Symbol: sym, Price: '0', Change: '0', '% Change': '0%',
    High:'', Low:'', Volume:'', 'Mkt Cap':'', '7D Spark':'1,1.1,1.08,1.12,1.05,1.07,1.1'
  }));
}

/* ===== RENDER ===== */
function renderHeatmap(rowsRaw){
  const wrap = document.getElementById('heatmap');
  const empty = document.getElementById('emptyState');
  wrap.innerHTML = '';

  let map = indexBySymbol(rowsRaw);
  if (map.size === 0){ map = indexBySymbol(fallbackRows()); }

  const ordered = TICKER_ORDER.map(sym => map.get(sym) || normRowTicker({Symbol:sym, Price:'', '% Change':''}));

  const pctVals = ordered.map(d => d.chgp).filter(Number.isFinite);
  const lo = pctVals.length ? Math.min(...pctVals) : 0;
  const hi = pctVals.length ? Math.max(...pctVals) : 0;
  document.getElementById('rangeInfo').textContent = `Range: ${lo.toFixed(2)}% … ${hi.toFixed(2)}%`;
  document.getElementById('countInfo').textContent = `${ordered.length} tickers`;

  if (!ordered.length){ empty.classList.remove('hidden'); return; }
  empty.classList.add('hidden');

  const frag = document.createDocumentFragment();
  ordered.forEach((d,i)=>{
    const colors = colorForPct(d.chgp);
    const div = document.createElement('div');
    div.innerHTML = makeTileHTMLTicker(d, colors, i);
    const tile = div.firstElementChild;

    // hover-only behavior
    tile.addEventListener('mouseenter', ()=> hc.show(tile));
    tile.addEventListener('mousemove',  ()=> hc.position(tile));
    tile.addEventListener('mouseleave', ()=> hc.hide());

    frag.appendChild(tile);
  });
  wrap.appendChild(frag);

  // draw sparks
  ordered.forEach((d,i)=> paintSpark(d,i));
}

/* ===== HYDRATE ===== */
async function hydrate(){
  const y = document.getElementById('year'); if (y) y.textContent = new Date().getFullYear();
  hc.init();

  // tickers marquee
  try {
    const headlines = await fetchSheetObjects(HEADLINES_SHEET_ID,'Headlines','A:B');
    const top    = headlines.filter(h=>/^top$/i.test((h.Section||'').toString())).map(h=>h.Text);
    const bottom = headlines.filter(h=>/^bottom$/i.test((h.Section||'').toString())).map(h=>h.Text);
    renderMarquee('topTicker', top, 'right');
    renderMarquee('bottomTicker', bottom, 'left');
  } catch(e){ console.warn('Headlines error', e); }

  // data
  let rows = await loadActive54();
  renderHeatmap(rows);

  const now = new Date();
  document.getElementById('lastUpdated').textContent =
    `Updated ${now.toLocaleString('en-IN')} · Source: ${rows && rows.length ? 'Active54' : 'Fallback'}`;
}

hydrate().catch(err => { console.error(err); showDiag('Unexpected error rendering heatmap — loaded fallback.'); });
</script>
</body>
</html>
