<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Terms of Service — bataSutra</title>
  <meta name="description" content="The terms governing your use of bataSutra products and services. Read about eligibility, acceptable use, IP, billing, disclaimers, and dispute resolution." />
  <meta name="theme-color" content="#8B0000">

  <!-- Perf warmup -->
  <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="dns-prefetch" href="//docs.google.com">
  <link rel="preconnect" href="https://docs.google.com" crossorigin>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root{ --brand:#8B0000; --brand-ink:#7a0000; --ink:#111; --muted:#6b7280; --bg:#ffffff; --soft:#f8fafc; --card:#ffffff; }
    html { font-family: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans"; }
    body { background: var(--bg); color: var(--ink); }
    section[id] { scroll-margin-top: 5.5rem; }

    .container { max-width: 80rem; margin: 0 auto; padding-left: 1rem; padding-right: 1rem; }
    .card { background: var(--card); border:1px solid #e5e7eb; border-radius: 1rem; box-shadow: 0 1px 2px rgba(0,0,0,.04); }
    .card:hover { box-shadow: 0 6px 18px rgba(0,0,0,.08); transition: box-shadow .2s ease; }

    .footer-red { background: var(--brand-ink); color:#fff; }
    .footer-red a { color: rgba(255,255,255,.92); }
    .footer-red a:hover { color:#fff; text-decoration: underline; }
    .footer-red .heading { font-size:.85rem; font-weight:700; letter-spacing:.04em; text-transform:uppercase; color: rgba(255,255,255,.82); }
    .footer-red .muted { color: rgba(255,255,255,.78); }
    .footer-red .divider { border-top:1px solid rgba(255,255,255,.18); }
    .footer-red .chip { font-size:.72rem; border:1px solid rgba(255,255,255,.28); border-radius:999px; padding:.25rem .5rem; color:#fff; background: rgba(255,255,255,.08); }

    /* Tickers */
    .ticker-rail { position: relative; overflow: hidden; }
    .ticker { display:flex; width:max-content; white-space:nowrap; gap:2.5rem; will-change: transform; transform: translateZ(0); }
    .ticker-left  { animation: scroll-left var(--dur,120s) linear infinite; }
    .ticker-right { animation: scroll-right var(--dur,120s) linear infinite; }
    .ticker:hover { animation-play-state: paused; }
    @keyframes scroll-left  { 0% { transform:translateX(0) } 100% { transform: translateX(-50%) } }
    @keyframes scroll-right { 0% { transform:translateX(-50%) } 100% { transform: translateX(0) } }
    @media (prefers-reduced-motion: reduce){ .ticker-left, .ticker-right { animation: none !important; } }

    .grid-bullet { background:#f8fafc; border:1px solid #e5e7eb; border-radius:.75rem; padding:.75rem; }
    .badge { font-size:.72rem; background:#f1f5f9; color:#0f172a; border:1px solid #e2e8f0; border-radius:999px; padding:.15rem .5rem; }
    .link-ink{ color:var(--brand-ink); } .link-ink:hover{ text-decoration:underline; }
    .toc a{ color:#0f172a } .toc a:hover{ color:var(--brand-ink); text-decoration:underline; }
  </style>
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "WebPage",
    "name": "Terms of Service",
    "about": ["terms", "tos", "acceptable use", "billing", "dispute resolution"],
    "publisher": {"@type": "Organization", "name": "bataSutra"}
  }
  </script>
</head>
<body>
  <!-- Top Ticker (Sheets → Headlines: Section=top) -->
  <div class="w-full bg-[var(--brand-ink)] text-white">
    <div class="flex items-center gap-3 py-2 px-4 sm:px-6 lg:px-8">
      <span class="inline-flex items-center gap-2 text-xs font-semibold bg-white/10 px-2.5 py-1 rounded-full">
        <span class="inline-block h-2 w-2 rounded-full bg-emerald-400 animate-pulse"></span> LIVE
      </span>
      <div class="ticker-rail flex-1" aria-label="Top headlines" aria-live="polite">
        <div id="topTicker" class="ticker ticker-right text-sm font-medium">
          <!-- First-paint fallback -->
          <span>Read our Terms carefully</span>
          <span>Plain-language obligations & rights</span>
          <span>Contact: legal@batasutra.in</span>
          <span>Privacy first; fair use encouraged</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Header -->
  <header class="sticky top-0 z-40 border-b bg-white/90 backdrop-blur supports-[backdrop-filter]:bg-white/70">
    <div class="container flex items-center justify-between py-3">
      <a href="/" class="flex items-center gap-3">
        <span class="grid place-items-center h-9 w-9 rounded-xl bg-[var(--brand)] text-white font-bold shadow-sm">bS</span>
        <div>
          <div class="text-lg font-bold leading-tight">bataSutra</div>
          <div class="text-xs text-[var(--muted)] -mt-0.5">News, context & tools</div>
        </div>
      </a>
      <div class="flex items-center gap-2"></div>
    </div>
  </header>

  <!-- Hero -->
  <section class="container pt-10 pb-6">
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 items-start">
      <div class="lg:col-span-2">
        <h1 class="text-3xl sm:text-4xl font-extrabold tracking-tight">Terms of Service</h1>
        <p class="text-slate-700 mt-3 max-w-2xl">These terms explain your rights and responsibilities when using bataSutra products and services.</p>
        <div class="mt-5 flex flex-wrap gap-3">
          <a href="#summary" class="px-4 py-2 rounded-lg bg-[var(--brand)] text-white text-sm font-medium">Summary</a>
          <a href="#details" class="px-4 py-2 rounded-lg border border-gray-300 text-sm font-medium">Full terms</a>
        </div>
      </div>
      <aside class="card p-5">
        <div class="text-sm text-slate-600">Effective & contacts</div>
        <ul class="mt-2 space-y-2 text-sm text-slate-700">
          <li class="grid-bullet"><strong>Effective:</strong> <span>Sep 01, 2025</span></li>
          <li class="grid-bullet"><strong>Last updated:</strong> <span>Sep 22, 2025</span></li>
          <li class="grid-bullet"><strong>Legal email:</strong> <a class="link-ink" href="mailto:legal@batasutra.in">legal@batasutra.in</a></li>
        </ul>
      </aside>
    </div>
  </section>

  <!-- Summary / At-a-glance -->
  <section id="summary" class="container py-6">
    <div class="card p-6 md:p-8">
      <h2 class="text-xl font-bold tracking-tight">At-a-glance</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mt-3">
        <div class="p-4 rounded-lg bg-slate-50 border border-slate-200">
          <div class="font-semibold">Acceptance</div>
          <div class="text-sm mt-1">By using our site, you agree to these Terms and our <a class="link-ink" href="/privacy">Privacy Policy</a>.</div>
        </div>
        <div class="p-4 rounded-lg bg-slate-50 border border-slate-200">
          <div class="font-semibold">Fair Use</div>
          <div class="text-sm mt-1">Personal use is fine; commercial use requires permission unless stated otherwise.</div>
        </div>
        <div class="p-4 rounded-lg bg-slate-50 border border-slate-200">
          <div class="font-semibold">Liability</div>
          <div class="text-sm mt-1">Services are provided “as is” to the fullest extent permitted by law.</div>
        </div>
      </div>
    </div>
  </section>

  <!-- Table of Contents -->
  <section class="container py-2">
    <div class="card p-6 md:p-8">
      <h2 class="text-xl font-bold tracking-tight">Contents</h2>
      <ol class="toc mt-3 list-decimal list-inside text-sm space-y-1">
        <li><a href="#scope">Scope & Parties</a></li>
        <li><a href="#changes">Changes to Terms</a></li>
        <li><a href="#eligibility">Eligibility & Accounts</a></li>
        <li><a href="#use">Acceptable Use</a></li>
        <li><a href="#ip">Content & IP</a></li>
        <li><a href="#feedback">Feedback</a></li>
        <li><a href="#billing">Subscriptions & Billing</a></li>
        <li><a href="#privacy">Privacy & Data</a></li>
        <li><a href="#warranties">Disclaimers</a></li>
        <li><a href="#liability">Limitation of Liability</a></li>
        <li><a href="#indemnity">Indemnity</a></li>
        <li><a href="#termination">Termination</a></li>
        <li><a href="#law">Governing Law & Disputes</a></li>
        <li><a href="#contact">Contact</a></li>
      </ol>
    </div>
  </section>

  <!-- Full Terms -->
  <section id="details" class="container py-6">
    <div class="card p-6 md:p-8 space-y-6">
      <section id="scope">
        <h3 class="text-lg font-bold">1) Scope & Parties</h3>
        <p class="text-sm text-slate-700 mt-2">These Terms govern access to and use of the bataSutra website, content, data products, and tools (“Services”). “We”, “us”, and “our” refer to bataSutra. “You” refers to the user of the Services.</p>
      </section>

      <section id="changes">
        <h3 class="text-lg font-bold">2) Changes to Terms</h3>
        <p class="text-sm text-slate-700 mt-2">We may update these Terms to reflect operational, legal, or regulatory changes. Material changes will be noted on this page with the “Last updated” date. Continued use after changes constitutes acceptance.</p>
      </section>

      <section id="eligibility">
        <h3 class="text-lg font-bold">3) Eligibility & Accounts</h3>
        <p class="text-sm text-slate-700 mt-2">You must be able to form a binding contract and comply with applicable laws. If you create an account, you are responsible for safeguarding credentials and for all activities under your account.</p>
      </section>

      <section id="use">
        <h3 class="text-lg font-bold">4) Acceptable Use</h3>
        <ul class="mt-2 text-sm text-slate-700 space-y-2">
          <li class="grid-bullet">Do not abuse, disrupt, or interfere with the Services or other users.</li>
          <li class="grid-bullet">No unauthorized scraping, automated access beyond documented rates, or circumvention of technical controls.</li>
          <li class="grid-bullet">No unlawful, infringing, defamatory, or harmful content or activity.</li>
        </ul>
      </section>

      <section id="ip">
        <h3 class="text-lg font-bold">5) Content & IP</h3>
        <p class="text-sm text-slate-700 mt-2">The Services, including articles, data, code, and brand assets, are protected by intellectual property laws. You receive a limited, non-exclusive, non-transferable license to access and use the Services for personal, non-commercial purposes unless expressly permitted otherwise. For commercial licensing, see <a class="link-ink" href="/licensing">Licensing</a>.</p>
      </section>

      <section id="feedback">
        <h3 class="text-lg font-bold">6) Feedback</h3>
        <p class="text-sm text-slate-700 mt-2">If you send ideas or suggestions, you grant us a perpetual, worldwide, royalty-free license to use them without restrictions or attribution.</p>
      </section>

      <section id="billing">
        <h3 class="text-lg font-bold">7) Subscriptions & Billing</h3>
        <p class="text-sm text-slate-700 mt-2">Paid features (if any) are billed in advance on a recurring basis unless canceled in accordance with the plan terms. Fees are non-refundable except as required by law.</p>
      </section>

      <section id="privacy">
        <h3 class="text-lg font-bold">8) Privacy & Data</h3>
        <p class="text-sm text-slate-700 mt-2">We handle personal data as described in our <a class="link-ink" href="/privacy">Privacy Policy</a> and <a class="link-ink" href="/cookies">Cookie Policy</a>. By using the Services, you consent to those practices.</p>
      </section>

      <section id="warranties">
        <h3 class="text-lg font-bold">9) Disclaimers</h3>
        <p class="text-sm text-slate-700 mt-2">The Services are provided “as is” and “as available.” We disclaim all warranties, express or implied, including merchantability, fitness for a particular purpose, and non-infringement. We do not guarantee accuracy, availability, or that the Services are error-free.</p>
      </section>

      <section id="liability">
        <h3 class="text-lg font-bold">10) Limitation of Liability</h3>
        <p class="text-sm text-slate-700 mt-2">To the maximum extent permitted by law, we are not liable for indirect, incidental, special, consequential, exemplary, or punitive damages, or any loss of profits, revenues, or data. Our aggregate liability for claims relating to the Services will not exceed the greater of ₹5,000 or the amount you paid to us in the 12 months prior to the claim.</p>
      </section>

      <section id="indemnity">
        <h3 class="text-lg font-bold">11) Indemnity</h3>
        <p class="text-sm text-slate-700 mt-2">You will indemnify and hold us harmless from claims, damages, liabilities, costs, and expenses (including reasonable legal fees) arising from your use of the Services or violation of these Terms.</p>
      </section>

      <section id="termination">
        <h3 class="text-lg font-bold">12) Termination</h3>
        <p class="text-sm text-slate-700 mt-2">We may suspend or terminate access if you breach these Terms or if required by law. Upon termination, your right to use the Services ends, but certain provisions survive (e.g., IP, disclaimers, limitations, indemnity, governing law).</p>
      </section>

      <section id="law">
        <h3 class="text-lg font-bold">13) Governing Law & Disputes</h3>
        <p class="text-sm text-slate-700 mt-2">These Terms are governed by the laws of India. Courts in Bengaluru, Karnataka will have exclusive jurisdiction, subject to any mandatory arbitration or consumer law rights that apply to you.</p>
      </section>

      <section id="contact">
        <h3 class="text-lg font-bold">14) Contact</h3>
        <p class="text-sm text-slate-700 mt-2">Questions? Email <a class="link-ink" href="mailto:legal@batasutra.in">legal@batasutra.in</a>. For security issues, see <a class="link-ink" href="/responsible-disclosure">Responsible Disclosure</a>.</p>
      </section>
    </div>
  </section>

  <!-- Bottom Ticker (Sheets → Headlines: Section=bottom) -->
  <div class="w-full bg-slate-50 border-t mt-12">
    <div class="container">
      <div class="flex items-center gap-3 py-2">
        <span class="inline-flex items-center gap-2 text-xs font-semibold bg-slate-200 px-2.5 py-1 rounded-full text-slate-800">LEGAL</span>
        <div class="ticker-rail flex-1" aria-label="Legal ticker" aria-live="polite">
          <div id="botTicker" class="ticker ticker-left text-sm text-slate-700">
            <!-- First-paint fallback -->
            <span>No legalese surprises</span>
            <span>Clear acceptable-use rules</span>
            <span>Contact legal@batasutra.in</span>
            <span>Privacy policy: /privacy</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Footer -->
  <footer class="footer-red text-sm mt-0">
    <div class="divider"></div>
    <div class="container py-10">
      <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-6">
        <a href="/" class="flex items-center gap-3">
          <span class="grid place-items-center h-9 w-9 rounded-xl bg-[var(--brand)] text-white font-bold shadow-sm">bS</span>
          <div>
            <div class="text-lg font-bold leading-tight">bataSutra</div>
            <div class="text-xs muted -mt-0.5"></div>
          </div>
        </a>
        <p class="muted max-w-2xl"></p>
      </div>

      <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-6 gap-8 mt-10">
        <div>
          <div class="heading mb-3">Editorial</div>
          <ul class="space-y-2">
            <li><a href="/articles">Latest</a></li>
            <li><a href="/deep-dive">Deep Dives</a></li>
            <li><a href="/weekend-wrap">Weekend Wrap</a></li>
            <li><a href="/explainers">Explainers</a></li>
            <li><a href="/policy">Policy &amp; Regulation</a></li>
            <li><a href="/quick-stats">Quick Stats</a></li>
            <li><a href="/archive">Archive</a></li>
          </ul>
        </div>
        <div>
          <div class="heading mb-3">Data</div>
          <ul class="space-y-2">
            <li><a href="/indices">Indices</a></li>
            <li><a href="/heatmap">Sector Heatmap</a></li>
            <li><a href="/commodities">Commodities</a></li>
            <li><a href="/dashboards/sectors">Sector Dashboards</a></li>
            <li><a href="/calendars/earnings">Earnings Calendar</a></li>
            <li><a href="/trackers/ipo">IPO Tracker</a></li>
            <li><a href="/trackers/budget">Budget Tracker</a></li>
          </ul>
        </div>
        <div>
          <div class="heading mb-3">Tools</div>
          <ul class="space-y-2">
            <li><a href="/tools">All Tools</a></li>
            <li><a href="/tools/sip-planner">SIP Goal &amp; Corpus</a></li>
            <li><a href="/tools/cagr">CAGR &amp; Quick IRR</a></li>
            <li><a href="/tools/ppf-ladder">PPF &amp; Emergency Ladder</a></li>
            <li><a href="/tools/tax-old-vs-new">Tax: Old vs New Slab</a></li>
            <li><a href="/tools/expense-runway">Expense Buckets &amp; Runway</a></li>
            <li><a href="/tools#changelog">Changelog</a></li>
          </ul>
        </div>
        <div>
          <div class="heading mb-3">Company</div>
          <ul class="space-y-2">
            <li><a href="/about">About</a></li>
            <li><a href="/dashboard/whats-inside.html">Inside the Dashboard</a></li>
            <li><a href="/advertise">Advertising &amp; Media Kit</a></li>
            <li><a href="/partnerships">Partnerships</a></li>
            <li><a href="/careers">Careers</a></li>
            <li><a href="/contact">Contact</a></li>
            <li><a href="/press">Press</a></li>
          </ul>
        </div>
        <div>
          <div class="heading mb-3">Resources</div>
          <ul class="space-y-2">
            <li><a href="/methodology">Methodology</a></li>
            <li><a href="/data-sources">Data Sources</a></li>
            <li><a href="/editorial-policy">Editorial Policy</a></li>
            <li><a href="/corrections">Corrections</a></li>
            <li><a href="/ethics">Ethics &amp; Independence</a></li>
            <li><a href="/style-guide">Style Guide</a></li>
            <li><a href="/accessibility">Accessibility</a></li>
            <li><a href="/sitemap">Sitemap</a></li>
          </ul>
        </div>
        <div>
          <div class="heading mb-3">Legal</div>
          <ul class="space-y-2">
            <li><a href="/privacy">Privacy Policy</a></li>
            <li><a href="/terms">Terms of Service</a></li>
            <li><a href="/cookies">Cookie Policy</a></li>
            <li><a href="/security">Security</a></li>
            <li><a href="/responsible-disclosure">Responsible Disclosure</a></li>
            <li><a href="/licensing">Licensing</a></li>
          </ul>
        </div>
      </div>

      <div class="divider mt-10"></div>
      <div class="py-6 flex flex-col md:flex-row items-start md:items-center justify-between gap-4">
        <div class="flex flex-wrap items-center gap-3">
          <a class="chip" href="#summary">Summary</a>
          <a class="chip" href="#details">Full terms</a>
        </div>
        <div class="muted">&copy; <span id="year"></span> bataSutra. All rights reserved.</div>
        <div class="flex items-center gap-4 muted">
          <button type="button" class="chip" onclick="window.scrollTo({top:0,behavior:'smooth'})">Back to top ↑</button>
        </div>
      </div>
    </div>
  </footer>

  <script>
    // ====== CONFIG (Sheets for tickers only) ======
    const SHEET_ID = '1WN8151jGQjqbfO0Aj2tK-79yJ9gCD_z0DLCdxs_higg';
    const HL_SHEET = 'Headlines';
    const HL_RANGE = 'A:C';
    const HL_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(HL_SHEET)}&range=${encodeURIComponent(HL_RANGE)}`;

    // Prefetch the CSV early (best-effort)
    const l = document.createElement('link'); l.rel = 'prefetch'; l.href = HL_URL; l.as = 'fetch'; l.crossOrigin = 'anonymous'; document.head.appendChild(l);

    // ====== Minimal CSV parser
    function parseCsv(text){
      const rows=[]; let row=[], cur='', inQuotes=false;
      for(let i=0;i<text.length;i++){
        const ch=text[i];
        if(inQuotes){
          if(ch === '"'){ if(text[i+1] === '"'){ cur+='"'; i++; } else { inQuotes=false; } }
          else cur+=ch;
        } else {
          if(ch === '"') inQuotes=true;
          else if(ch === ','){ row.push(cur); cur=''; }
          else if(ch === '\n'){ row.push(cur); rows.push(row); row=[]; cur=''; }
          else if(ch !== '\r'){ cur+=ch; }
        }
      }
      if(cur.length>0 || row.length>0){ row.push(cur); rows.push(row); }
      return rows;
    }

    // ====== Headlines cache (localStorage) — 15 min TTL
    const HL_CACHE_KEY = 'bs_headlines_v2';
    const HL_TTL_MS = 15 * 60 * 1000;

    function getHLCache(){
      try{
        const raw = localStorage.getItem(HL_CACHE_KEY);
        if(!raw) return null;
        const {ts, data} = JSON.parse(raw);
        if(Date.now() - ts > HL_TTL_MS) return null;
        return data;
      }catch{ return null; }
    }
    function setHLCache(data){
      try{ localStorage.setItem(HL_CACHE_KEY, JSON.stringify({ts:Date.now(), data})); }catch{}
    }

    // ====== Fetch with timeout (700ms)
    function fetchWithTimeout(url, opts={}, ms=700){
      return new Promise((resolve,reject)=>{
        const ctrl = new AbortController(); const t = setTimeout(()=>{ ctrl.abort(); reject(new Error('timeout')); }, ms);
        fetch(url, {...opts, signal: ctrl.signal, cache:'force-cache', credentials:'omit'})
          .then(r=>{ clearTimeout(t); resolve(r); })
          .catch(e=>{ clearTimeout(t); reject(e); });
      });
    }

    async function fetchHeadlinesFast(){
      try{
        const res = await fetchWithTimeout(HL_URL);
        if(!res.ok) throw new Error('HTTP '+res.status);
        const txt = await res.text();
        if (txt.trim().startsWith('<')) return []; // sharing disabled
        const rows = parseCsv(txt);
        if(!rows.length) return [];
        const hdr = rows[0].map(h => h.replace(/^\uFEFF/,'').trim().toLowerCase());
        const iS = hdr.indexOf('section'), iT = hdr.indexOf('text');
        if(iS<0 || iT<0) return [];
        return rows.slice(1)
          .map(r => ({ section:(r[iS]||'').toLowerCase().trim(), text:(r[iT]||'').trim() }))
          .filter(r => r.text);
      }catch{ return null; }
    }

    // ====== Ticker helpers
    function setAutoDuration(el, items){
      const len = (items||[]).join(' • ').length || 120;
      const secs = Math.min(140, Math.max(60, Math.round(len/1.8)));
      el.style.setProperty('--dur', secs+'s');
    }

    function renderTicker(el, items, dir){
      if(!el || !items?.length) return; // keep fallback
      el.className = `ticker ${dir==='right'?'ticker-right':'ticker-left'} ${el.id==='botTicker'?'text-sm text-slate-700':'text-sm font-medium'}`;
      el.innerHTML = '';
      const loop = items.concat(items);
      loop.forEach(t => { const span=document.createElement('span'); span.textContent=t; el.appendChild(span); });
      setAutoDuration(el, items);
    }

    function paintFromData(data){
      const topEl = document.getElementById('topTicker');
      const botEl = document.getElementById('botTicker');
      if(!data) return;
      const top = data.filter(d=>d.section==='top').map(d=>d.text);
      const bottom = data.filter(d=>d.section==='bottom').map(d=>d.text);
      if(top.length) renderTicker(topEl, top, 'right');
      if(bottom.length) renderTicker(botEl, bottom, 'left');
    }

    // ====== Service Worker (SWR for CSV)
    async function registerTickerSW(){
      if(!('serviceWorker' in navigator)) return;
      const swCode = `
        const CACHE = 'bs-tickers-v1';
        const HL_URL = ${JSON.stringify(HL_URL)};
        self.addEventListener('install', e=>{
          e.waitUntil(caches.open(CACHE).then(c=>c.add(HL_URL)).catch(()=>{}));
          self.skipWaiting();
        });
        self.addEventListener('activate', e=>{ self.clients.claim(); });
        self.addEventListener('fetch', e=>{
          const url = new URL(e.request.url);
          if (url.href === HL_URL) {
            e.respondWith((async ()=>{
              const cache = await caches.open(CACHE);
              const cached = await cache.match(HL_URL);
              const netPromise = fetch(HL_URL, {cache:'no-store'}).then(async r=>{
                if(r.ok) { await cache.put(HL_URL, r.clone()); postUpdate(); }
                return r;
              }).catch(()=>null);
              return cached || netPromise || fetch(HL_URL, {cache:'force-cache'});
            })());
          }
        });
        async function postUpdate(){
          const clientsArr = await self.clients.matchAll({includeUncontrolled:true, type:'window'});
          for (const c of clientsArr) c.postMessage({type:'bs:hl-updated'});
        }
      `;
      const blob = new Blob([swCode], {type:'text/javascript'});
      const url = URL.createObjectURL(blob);
      try { await navigator.serviceWorker.register(url, {scope: './'}); } catch(e){ /* ignore */ }
    }

    // Listen for SW updates to repaint
    navigator.serviceWorker?.addEventListener?.('message', async (evt)=>{
      if(evt?.data?.type === 'bs:hl-updated'){
        const res = await fetch(HL_URL, {cache:'force-cache'});
        if(res.ok){
          const txt = await res.text();
          if(!txt.trim().startsWith('<')){
            const rows = parseCsv(txt);
            if(rows.length){
              const hdr = rows[0].map(h => h.replace(/^\uFEFF/,'').trim().toLowerCase());
              const iS = hdr.indexOf('section'), iT = hdr.indexOf('text');
              if(iS>=0 && iT>=0){
                const data = rows.slice(1).map(r=>({section:(r[iS]||'').toLowerCase().trim(), text:(r[iT]||'').trim()})).filter(r=>r.text);
                setHLCache(data); paintFromData(data);
              }
            }
          }
        }
      }
    });

    // ====== Boot
    async function boot(){
      document.getElementById('year').textContent = new Date().getFullYear();

      // Respect reduced motion
      if (window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
        document.querySelectorAll('.ticker-left, .ticker-right').forEach(el=>{ el.style.animation='none'; });
      }

      // 1) First-paint from local cache (if any)
      const cached = getHLCache();
      if(cached) paintFromData(cached);

      // 2) Register SW (cache-first + background refresh)
      await registerTickerSW();

      // 3) Opportunistic fast network fetch (700ms cap)
      const fast = await fetchHeadlinesFast();
      if (fast) { setHLCache(fast); paintFromData(fast); }
    }

    window.addEventListener('DOMContentLoaded', boot);
  </script>
</body>
</html>
